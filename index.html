<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ù†Ø¸Ø§Ù… ØªØ­Ù„ÙŠÙ„ Ù…Ø¨Ø§Ø¯Ø±Ø© Ø§Ø±ØªÙ‚Ø§Ø¡</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">

    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --primary-color: #1e293b;
        --accent-color: #2563eb;
        --success-color: #059669;
        --danger-color: #dc2626;
        --bg-color: #f8fafc;
        --border-color: #cbd5e1;
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: "Cairo", sans-serif;
        background-color: var(--bg-color);
        margin: 0;
        padding: 20px;
        color: #334155;
        direction: rtl;
      }

      /* --- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… --- */
      .control-panel {
        background: #ffffff;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        margin-bottom: 40px;
        border: 1px solid var(--border-color);
        max-width: 1100px;
        margin-left: auto;
        margin-right: auto;
      }

      .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 2px solid #f1f5f9;
        padding-bottom: 15px;
        margin-bottom: 20px;
      }

      .control-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .control-group h3 {
        font-size: 14px;
        color: var(--accent-color);
        margin-bottom: 10px;
        font-weight: 700;
      }

      .input-field {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-family: "Cairo";
        font-size: 13px;
        margin-bottom: 8px;
      }

      .actions-bar {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #f1f5f9;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-family: "Cairo";
        font-weight: 700;
        font-size: 14px;
      }
      .btn-primary {
        background: var(--accent-color);
        color: white;
      }
      .btn-success {
        background: var(--success-color);
        color: white;
      }
      .btn-danger {
        background: #fee2e2;
        color: var(--danger-color);
      }
      .btn-outline {
        background: white;
        border: 1px solid var(--border-color);
        color: #64748b;
      }

      .file-upload-wrapper {
        border: 2px dashed var(--accent-color);
        padding: 20px;
        text-align: center;
        border-radius: 12px;
        background: #eff6ff;
        cursor: pointer;
        margin-top: 10px;
      }

      /* --- ØµÙØ­Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± (A4) --- */
      .page-container {
        width: 210mm;
        min-height: 297mm;
        margin: 0 auto;
        background: #fff;
        padding: 15mm;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        position: relative;
      }

      /* Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© (Ø§Ù„ÙƒÙ„ÙŠØ´Ø©) */
      .header-section {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        border-bottom: 3px solid var(--primary-color);
        padding-bottom: 10px;
        margin-bottom: 20px;
      }
      .header-col {
        flex: 1;
        text-align: center;
      }

      .header-right .header-text,
      .header-left .header-text {
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 4px;
        white-space: nowrap;
      }

      .report-title {
        font-weight: 800;
        font-size: 18px;
        color: var(--primary-color);
        margin-bottom: 5px;
        white-space: nowrap;
      }

      .header-left .header-text {
        text-align: left;
        padding-left: 10px;
      }

      /* Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª */
      .info-bar {
        background-color: #f8fafc;
        border: 1px solid #e2e8f0;
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 25px;
        display: flex;
        justify-content: space-around;
        font-weight: 700;
        font-size: 14px;
      }

      /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
      .table-section {
        margin-bottom: 30px;
        width: 100%;
        break-inside: avoid;
        page-break-inside: avoid;
      }

      .section-title {
        font-family: "Cairo", sans-serif;
        font-weight: 800;
        font-size: 16px;
        color: var(--primary-color);
        margin-bottom: 8px;
        border-right: 6px solid var(--accent-color);
        padding-right: 12px;
        background-color: #f1f5f9;
        padding: 5px;
        border-radius: 4px;
        text-align: right;
        page-break-after: avoid;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
        margin-bottom: 5px;
      }
      th,
      td {
        border: 1px solid #94a3b8;
        padding: 6px 4px;
        text-align: center;
      }

      .header-counts th {
        background-color: #1e293b;
        color: #fff;
      }
      .header-percents th {
        background-color: #0f766e;
        color: #fff;
      }
      .header-stats-1 th {
        background-color: #4338ca;
        color: #fff;
      }
      .header-stats-2 th {
        background-color: #c2410c;
        color: #fff;
      }

      tr:nth-child(even) {
        background-color: #f8fafc;
      }
      .percent-cell {
        font-weight: 700;
        color: var(--accent-color);
        direction: ltr;
      }

      /* Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ */
      .chart-section {
        margin-top: auto;
        break-inside: avoid;
        page-break-inside: avoid;
        padding-bottom: 20px;
      }
      .chart-container {
        width: 100%;
        height: 400px !important;
        padding: 10px;
        background: #fff;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
      }

      /* Ø§Ù„ØªØ°ÙŠÙŠÙ„ */
      .footer-section {
        margin-top: 50px;
        display: flex;
        justify-content: space-between;
        padding: 0 40px;
        break-inside: avoid;
      }
      .signature-box {
        text-align: center;
        width: 220px;
      }
      .signature-title {
        font-weight: bold;
        margin-bottom: 40px;
        font-size: 15px;
      }
      .signature-line {
        border-top: 1px solid #333;
        padding-top: 5px;
        font-weight: bold;
        font-size: 15px;
      }

      /* Ø·Ø¨Ø§Ø¹Ø© */
      @media print {
        .control-panel {
          display: none;
        }
        body {
          background: white;
          padding: 0;
        }
        .page-container {
          margin: 0;
          box-shadow: none;
          width: 100%;
          padding: 10mm;
        }
        .chart-container {
          height: 350px !important;
          border: 1px solid #ccc;
        }
        .section-title {
          background-color: #eee !important;
          -webkit-print-color-adjust: exact;
        }
        th {
          -webkit-print-color-adjust: exact;
        }
        .header-text {
          font-size: 12px !important;
        }
        .footer-section {
          margin-top: 40px !important;
        }
      }
      /* --- ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ø§Ù„Ø³ÙÙ„ÙŠ (Ø­Ù‚ÙˆÙ‚ Ø§Ù„ØªØ·ÙˆÙŠØ±) --- */
      .app-footer {
        text-align: center; /* ØªÙˆØ³ÙŠØ· */
        font-size: 12px; /* ØªØµØºÙŠØ± Ø§Ù„Ø®Ø· */
        margin-top: 50px; /* Ù…Ø³Ø§ÙØ© Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ */
        margin-bottom: 20px; /* Ù…Ø³Ø§ÙØ© Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„ */
        color: #64748b; /* Ù„ÙˆÙ† Ø±Ù…Ø§Ø¯ÙŠ Ø£Ù†ÙŠÙ‚ */
        font-weight: 600;
      }
      .app-footer a {
        color: var(--accent-color);
        text-decoration: none;
      }
      .app-footer a:hover {
        text-decoration: underline;
      }

      /* --- ÙƒÙ„Ø§Ø³ Ù„Ù…Ù†Ø¹ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© --- */
      /* ØªØ£ÙƒØ¯ Ø£Ù† Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø®Ù„ Ø£Ùˆ Ù…Ø¹ Ø£ÙƒÙˆØ§Ø¯ @media print */
      @media print {
        .no-print {
          display: none !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="control-panel">
      <div class="panel-header">
        <div>
          <h2 style="margin: 0; color: var(--primary-color)">
            ğŸ“Š Ù†Ø¸Ø§Ù… ØªØ­Ù„ÙŠÙ„ Ù…Ø¨Ø§Ø¯Ø±Ø© Ø§Ø±ØªÙ‚Ø§Ø¡ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠ
          </h2>
        </div>
        <div style="display: flex; gap: 10px">
          <button class="btn btn-outline" onclick="saveSettings()">
            ğŸ’¾ Ø­ÙØ¸
          </button>
          <button class="btn btn-danger" onclick="clearSettings()">
            ğŸ§¹ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
          </button>
        </div>
      </div>

      <div class="control-grid">
        <div class="control-group">
          <h3>ğŸ”¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© (Ø§Ù„ÙƒÙ„ÙŠØ´Ø©)</h3>
          <input
            type="text"
            id="inp_right1"
            class="input-field"
            value="Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©"
            oninput="updateUI()"
          />
          <input
            type="text"
            id="inp_right2"
            class="input-field"
            value="ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…"
            oninput="updateUI()"
          />
          <input
            type="text"
            id="inp_right3"
            class="input-field"
            value="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ… Ø¨Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±ÙŠØ§Ø¶"
            oninput="updateUI()"
          />
        </div>

        <div class="control-group">
          <h3>ğŸ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ±</h3>
          <input
            type="text"
            id="inp_school"
            class="input-field"
            placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©..."
            oninput="updateUI()"
          />
          <input
            type="text"
            id="inp_report_title"
            class="input-field"
            value="ØªÙ‚Ø±ÙŠØ± ØªØ­Ù„ÙŠÙ„ Ù…Ø¨Ø§Ø¯Ø±Ø© Ø§Ø±ØªÙ‚Ø§Ø¡"
            placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙ‚Ø±ÙŠØ±"
            oninput="updateUI()"
          />
          <input
            type="text"
            id="inp_year"
            class="input-field"
            value="1447 Ù‡Ù€"
            placeholder="Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ"
            oninput="updateUI()"
          />
          <input
            type="text"
            id="inp_term"
            class="input-field"
            value="Ø§Ù„Ø«Ø§Ù†ÙŠ"
            placeholder="Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ"
            oninput="updateUI()"
          />
        </div>

        <div class="control-group">
          <h3>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„ØµÙ</h3>
          <input
            type="text"
            id="inp_grade"
            class="input-field"
            placeholder="Ø§Ù„ØµÙ (Ù…Ø«Ø§Ù„: Ø§Ù„Ø³Ø§Ø¯Ø³)"
            oninput="updateUI()"
          />
          <input
            type="text"
            id="inp_section"
            class="input-field"
            placeholder="Ø§Ù„ÙØµÙ„"
            oninput="updateUI()"
          />
          <input
            type="number"
            id="inp_max_score"
            class="input-field"
            placeholder="Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø¹Ø¸Ù…Ù‰ (Ù„Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©)"
            value="15"
          />
        </div>

        <div class="control-group">
          <h3>âœï¸ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ ÙˆØ§Ù„ØªØ°ÙŠÙŠÙ„</h3>
          <input
            type="text"
            id="inp_principal"
            class="input-field"
            placeholder="Ø§Ø³Ù… Ù…Ø¯ÙŠØ±/Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©"
            oninput="updateUI()"
          />
          <input
            type="text"
            id="inp_date"
            class="input-field"
            placeholder="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"
            oninput="updateUI()"
          />
        </div>
      </div>

      <div
        class="file-upload-wrapper"
        onclick="document.getElementById('fileInput').click()"
      >
        <h3 style="margin-top: 0; color: var(--accent-color)">
          ğŸ“‚ Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¥ÙƒØ³Ù„
        </h3>
        <p style="margin-bottom: 0; color: #64748b; font-size: 13px">
          ÙŠØ¯Ø¹Ù… Ù…Ù„ÙØ§Øª Ø§Ø±ØªÙ‚Ø§Ø¡ + Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
        </p>
        <input
          type="file"
          id="fileInput"
          multiple
          accept=".xlsx, .xls, .csv"
          style="display: none"
          onchange="handleFiles(this.files)"
        />
      </div>

      <div class="actions-bar">
        <button class="btn btn-outline" onclick="newAnalysis()">
          âœ¨ ØªØ­Ù„ÙŠÙ„ Ø¬Ø¯ÙŠØ¯
        </button>
        <button class="btn btn-success" onclick="exportToExcel()">
          ğŸ“ˆ ØªØµØ¯ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ (Excel)
        </button>
        <button class="btn btn-primary" onclick="window.print()">
          ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
        </button>
      </div>
    </div>

    <div class="page-container" id="reportContainer">
      <div class="header-section">
        <div class="header-col header-right">
          <div class="header-text" id="out_right1"></div>
          <div class="header-text" id="out_right2"></div>
          <div class="header-text" id="out_right3"></div>
        </div>

        <div class="header-col header-center">
          <div class="report-title" id="out_report_title">
            ØªÙ‚Ø±ÙŠØ± ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨
          </div>
          <div
            class="header-text"
            style="color: var(--accent-color); font-size: 15px; margin-top: 5px"
            id="out_school"
          ></div>
        </div>

        <div class="header-col header-left">
          <div class="header-text">
            Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ: <span id="out_year"></span>
          </div>
          <div class="header-text">
            Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ: <span id="out_term"></span>
          </div>
        </div>
      </div>

      <div class="info-bar">
        <div>Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ: <span id="out_grade">--</span></div>
        <div>Ø§Ù„ÙØµÙ„: <span id="out_section">--</span></div>
        <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨: <span id="out_total_students">0</span></div>
      </div>

      <div id="tablesContainer"></div>

      <div id="statsTableContainer"></div>

      <div class="chart-section">
        <div class="chart-container">
          <canvas id="gradesChart"></canvas>
        </div>
      </div>

      <div class="footer-section">
        <div class="signature-box">
          <div class="signature-title">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯</div>
          <div
            class="signature-line"
            id="out_date"
            style="border: none; border-bottom: 1px dotted #999"
          ></div>
        </div>
        <div class="signature-box">
          <div class="signature-title">Ù…Ø¯ÙŠØ±/Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</div>
          <div class="signature-line" id="out_principal"></div>
        </div>
      </div>
    </div>

    <script>
      // ==========================================
      // ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØ§Ù„ØªØ´ØºÙŠÙ„
      // ==========================================
      const gradesOrder = ["Ù…Ù…ØªØ§Ø²", "Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹", "Ø¬ÙŠØ¯", "Ù…Ù‚Ø¨ÙˆÙ„", "Ø¶Ø¹ÙŠÙ"];
      const gradeColors = {
        Ù…Ù…ØªØ§Ø²: "#059669",
        "Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹": "#2563eb",
        Ø¬ÙŠØ¯: "#0891b2",
        Ù…Ù‚Ø¨ÙˆÙ„: "#d97706",
        Ø¶Ø¹ÙŠÙ: "#dc2626",
      };
      const IGNORED_SUBJECTS = [
        "Ø§Ù„Ù…ÙˆØ§Ø¸Ø¨Ø©",
        "Ø§Ù„Ø³Ù„ÙˆÙƒ",
        "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹",
        "Ø§Ù„Ù†ØªÙŠØ¬Ø©",
        "Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¨Ø¯Ù†ÙŠØ©",
        "Ø§Ù„ÙÙ†ÙŠØ©",
      ];
      const STORAGE_KEY = "analysis_settings_v26";

      let globalSubjects = [];
      let globalCounts = {};
      let subjectTotals = {};
      let subjectScores = {};

      window.onload = function () {
        loadSettings();
        updateUI();
      };

      // --- Settings ---
      function saveSettings() {
        const settings = {
          right1: document.getElementById("inp_right1").value,
          right2: document.getElementById("inp_right2").value,
          right3: document.getElementById("inp_right3").value,
          school: document.getElementById("inp_school").value,
          reportTitle: document.getElementById("inp_report_title").value,
          year: document.getElementById("inp_year").value,
          term: document.getElementById("inp_term").value,
          grade: document.getElementById("inp_grade").value,
          section: document.getElementById("inp_section").value,
          principal: document.getElementById("inp_principal").value,
          date: document.getElementById("inp_date").value,
          maxScore: document.getElementById("inp_max_score").value,
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
        alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
      }

      function loadSettings() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const s = JSON.parse(saved);
          if (s.right1) document.getElementById("inp_right1").value = s.right1;
          if (s.right2) document.getElementById("inp_right2").value = s.right2;
          if (s.right3) document.getElementById("inp_right3").value = s.right3;
          if (s.school) document.getElementById("inp_school").value = s.school;
          if (s.reportTitle)
            document.getElementById("inp_report_title").value = s.reportTitle;
          if (s.year) document.getElementById("inp_year").value = s.year;
          if (s.term) document.getElementById("inp_term").value = s.term;
          if (s.grade) document.getElementById("inp_grade").value = s.grade;
          if (s.section)
            document.getElementById("inp_section").value = s.section;
          if (s.principal)
            document.getElementById("inp_principal").value = s.principal;
          if (s.date) document.getElementById("inp_date").value = s.date;
          if (s.maxScore)
            document.getElementById("inp_max_score").value = s.maxScore;
          updateUI();
        }
      }

      function clearSettings() {
        if (confirm("Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªØŸ")) {
          localStorage.removeItem(STORAGE_KEY);
          location.reload();
        }
      }

      function newAnalysis() {
        if (confirm("Ø¨Ø¯Ø¡ ØªØ­Ù„ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ ÙˆÙ…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŸ")) {
          globalSubjects = [];
          globalCounts = {};
          subjectTotals = {};
          subjectScores = {};
          document.getElementById("tablesContainer").innerHTML = "";
          document.getElementById("statsTableContainer").innerHTML = "";
          document.getElementById("out_total_students").innerText = "0";
          if (window.myChart) window.myChart.destroy();
          document.getElementById("fileInput").value = "";
        }
      }

      function updateUI() {
        const mapping = {
          right1: "right1",
          right2: "right2",
          right3: "right3",
          school: "school",
          report_title: "report_title",
          year: "year",
          term: "term",
          grade: "grade",
          section: "section",
          principal: "principal",
          date: "date",
        };
        for (let key in mapping) {
          const el = document.getElementById("out_" + mapping[key]);
          const inp = document.getElementById("inp_" + key);
          if (el && inp) {
            // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬ÙˆÙ‡Ø±ÙŠ Ù‡Ù†Ø§:
            // Ù†Ù…Ø±Ø± Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¹Ø¨Ø± Ø¯Ø§Ù„Ø© toArabicNumerals Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø±Ø¶
            el.innerText = toArabicNumerals(inp.value);
          }
        }
      }

      // --- File Processing ---
      async function handleFiles(files) {
        if (!files || files.length === 0) return;
        for (let i = 0; i < files.length; i++) {
          await readSingleFile(files[i]);
        }
        updateReport();
      }

      function readSingleFile(file) {
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: "array" });
            processWorkbook(workbook);
            resolve();
          };
          reader.readAsArrayBuffer(file);
        });
      }

      function processWorkbook(workbook) {
        let processedAsMulti = false;
        workbook.SheetNames.forEach((sheetName) => {
          const sheet = workbook.Sheets[sheetName];
          const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
          let isMulti = false;
          for (let r = 0; r < Math.min(json.length, 15); r++) {
            const rowStr = JSON.stringify(json[r] || []);
            if (
              rowStr.includes("Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒÙ„ÙŠØ©") ||
              (rowStr.includes("Ø§Ù„Ù…Ø§Ø¯Ø©") && rowStr.includes("Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨"))
            ) {
              isMulti = true;
              break;
            }
          }
          if (isMulti) {
            processMultiSubjectSheet(json);
            processedAsMulti = true;
          }
        });

        if (!processedAsMulti) {
          processStandardSheet(workbook.Sheets[workbook.SheetNames[0]]);
        }
      }

      function processMultiSubjectSheet(json) {
        let subjectRowIdx = -1,
          maxScoreRowIdx = -1,
          headerRowIdx = -1;
        for (let r = 0; r < Math.min(json.length, 25); r++) {
          const rowStr = (json[r] || []).join(" ");
          if (rowStr.includes("Ø§Ù„Ù…Ø§Ø¯Ø©") && subjectRowIdx === -1)
            subjectRowIdx = r;
          if (rowStr.includes("Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒÙ„ÙŠØ©") && maxScoreRowIdx === -1)
            maxScoreRowIdx = r;
          if (rowStr.includes("Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨") && headerRowIdx === -1)
            headerRowIdx = r;
        }
        if (subjectRowIdx === -1) return;

        const dataStartIdx =
          headerRowIdx !== -1
            ? headerRowIdx + 1
            : maxScoreRowIdx !== -1
              ? maxScoreRowIdx + 1
              : subjectRowIdx + 2;
        const subjects = json[subjectRowIdx];
        const maxScores = maxScoreRowIdx !== -1 ? json[maxScoreRowIdx] : [];

        for (let c = 1; c < subjects.length; c++) {
          let subjectName = subjects[c];
          if (!subjectName) continue;
          const safeKey = initSubject(subjectName);
          if (safeKey === "skip") continue;
          let maxScore = 15;
          if (maxScores && maxScores[c]) {
            const parsed = parseFloat(maxScores[c]);
            if (!isNaN(parsed) && parsed > 0) maxScore = parsed;
          }
          for (let r = dataStartIdx; r < json.length; r++) {
            const row = json[r];
            if (!row || !row[0]) continue;
            const val = row[c];
            if (val !== undefined && val !== null && val !== "") {
              const score = parseFloat(val);
              if (!isNaN(score)) calculateAndStore(safeKey, score, maxScore);
            }
          }
        }
      }

      function processStandardSheet(sheet) {
        const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
        const userMaxScore =
          parseFloat(document.getElementById("inp_max_score").value) || 100;
        if (json.length < 2) return;
        const headerRow = json[0];
        for (let c = 1; c < headerRow.length; c++) {
          const subjectName = headerRow[c];
          if (!subjectName) continue;
          const safeKey = initSubject(subjectName);
          if (safeKey === "skip") continue;
          for (let r = 1; r < json.length; r++) {
            const row = json[r];
            if (!row) continue;
            const val = row[c];
            if (val !== undefined && val !== null) {
              const score = parseFloat(val);
              if (!isNaN(score))
                calculateAndStore(safeKey, score, userMaxScore);
            }
          }
        }
      }

      function initSubject(subject) {
        subject = (subject + "").trim();
        if (IGNORED_SUBJECTS.some((ignored) => subject.includes(ignored)))
          return "skip";
        subject = subject.replace(/_/g, " ").replace(/[0-9]/g, "").trim();
        if (subject.length < 2) return "skip";
        if (!globalSubjects.includes(subject)) {
          globalSubjects.push(subject);
          globalCounts[subject] = {
            Ø¶Ø¹ÙŠÙ: 0,
            Ù…Ù‚Ø¨ÙˆÙ„: 0,
            Ø¬ÙŠØ¯: 0,
            "Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹": 0,
            Ù…Ù…ØªØ§Ø²: 0,
          };
          subjectTotals[subject] = 0;
          subjectScores[subject] = [];
        }
        return subject;
      }

      function calculateAndStore(subject, score, maxScore) {
        const pct = (score / maxScore) * 100;
        let grade = "Ø¶Ø¹ÙŠÙ";
        if (pct >= 90) grade = "Ù…Ù…ØªØ§Ø²";
        else if (pct >= 80) grade = "Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹";
        else if (pct >= 70) grade = "Ø¬ÙŠØ¯";
        else if (pct >= 50) grade = "Ù…Ù‚Ø¨ÙˆÙ„";
        globalCounts[subject][grade]++;
        subjectTotals[subject]++;
        subjectScores[subject].push(score);
      }

      // --- Rendering ---
      function updateReport() {
        let maxStudents = 0;
        globalSubjects.forEach((s) => {
          if (subjectTotals[s] > maxStudents) maxStudents = subjectTotals[s];
        });
        // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ø¥Ø¶Ø§ÙØ© toArabicNumerals
        document.getElementById("out_total_students").innerText =
          toArabicNumerals(maxStudents);
        renderTables();
        renderStatsTable();
        renderChart();
      }

      function renderTables() {
        const container = document.getElementById("tablesContainer");
        if (globalSubjects.length === 0) {
          container.innerHTML =
            "<p style='text-align:center; color:#94a3b8;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶.</p>";
          return;
        }

        // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ (ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡ Ù„ÙŠØ¹Ø±Ø¶ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)
        let htmlCounts = `
          <div class="table-section">
            <div class="section-title">Ø£ÙˆÙ„Ø§Ù‹: ØªÙˆØ²ÙŠØ¹ Ø£Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø­Ø³Ø¨ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±Ø§Øª</div>
            <table>
              <thead class="header-counts">
                <tr><th style="width: 25%;">Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</th>${gradesOrder.map((g) => `<th>${g}</th>`).join("")}<th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th></tr>
              </thead>
              <tbody>`;
        globalSubjects.forEach((sub) => {
          const total = subjectTotals[sub] || 0;
          let tr = `<tr><td style="font-weight:bold; background:#f8fafc;">${sub}</td>`;
          gradesOrder.forEach((g) => {
            // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±Ù‚Ù…
            tr += `<td class="grade-cell">${toArabicNumerals(globalCounts[sub][g])}</td>`;
          });
          // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹
          tr += `<td style="font-weight:bold; background:#e2e8f0;">${toArabicNumerals(total)}</td></tr>`;
          htmlCounts += tr;
        });
        htmlCounts += `</tbody></table></div>`;

        // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†Ø³Ø¨ (ÙƒØ§Ù† Ø³Ù„ÙŠÙ…Ø§Ù‹ØŒ Ù„ÙƒÙ† Ù†Ø¶Ø¹Ù‡ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙˆØ§ÙÙ‚)
        let htmlPcts = `
          <div class="table-section">
            <div class="section-title">Ø«Ø§Ù†ÙŠØ§Ù‹: Ù†Ø³Ø¨ ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±Ø§Øª (%)</div>
            <table>
              <thead class="header-percents">
                <tr><th style="width: 25%;">Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</th>${gradesOrder.map((g) => `<th>${g}</th>`).join("")}</tr>
              </thead>
              <tbody>`;
        globalSubjects.forEach((sub) => {
          const total = subjectTotals[sub] || 1;
          let tr = `<tr><td style="font-weight:bold; background:#f8fafc;">${sub}</td>`;
          gradesOrder.forEach((g) => {
            const pct = ((globalCounts[sub][g] / total) * 100).toFixed(1) + "%";
            tr += `<td class="percent-cell">${toArabicNumerals(pct)}</td>`;
          });
          tr += `</tr>`;
          htmlPcts += tr;
        });
        htmlPcts += `</tbody></table></div>`;
        container.innerHTML = htmlCounts + htmlPcts;
      }

      function renderStatsTable() {
        const container = document.getElementById("statsTableContainer");
        let html = "";

        html += `
        <div class="table-section">
            <div class="section-title">Ø«Ø§Ù„Ø«Ø§Ù‹: Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø©</div>
            <table>
                <thead class="header-stats-1">
                    <tr><th style="width: 25%;">Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</th><th>Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠ</th><th>Ø§Ù„ÙˆØ³ÙŠØ·</th><th>Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù Ø§Ù„Ù…Ø¹ÙŠØ§Ø±ÙŠ</th><th>Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­</th></tr>
                </thead>
                <tbody>`;
        globalSubjects.forEach((sub) => {
          const scores = subjectScores[sub] || [];
          const mean = calcMean(scores);
          const median = calcMedian(scores);
          const stdDev = calcStdDev(scores);
          const total = subjectTotals[sub] || 1;
          const weak = globalCounts[sub]["Ø¶Ø¹ÙŠÙ"] || 0;
          const passRate = (((total - weak) / total) * 100).toFixed(1) + "%";
          html += `<tr><td style="font-weight:bold;">${sub}</td><td>${toArabicNumerals(mean)}</td><td>${toArabicNumerals(median)}</td><td>${toArabicNumerals(stdDev)}</td><td style="font-weight:bold; color:var(--success-color); direction:ltr;">${toArabicNumerals(passRate)}</td></tr>`;
        });
        html += `</tbody></table></div>`;

        html += `
        <div class="table-section">
            <div class="section-title">Ø±Ø§Ø¨Ø¹Ø§Ù‹: Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„Ù…Ø¯Ù‰</div>
            <table>
                <thead class="header-stats-2">
                    <tr><th style="width: 25%;">Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</th><th>Ø£Ø¹Ù„Ù‰ Ø¯Ø±Ø¬Ø©</th><th>Ø£Ù‚Ù„ Ø¯Ø±Ø¬Ø©</th><th>Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙ…ÙŠØ² (Ù…Ù…ØªØ§Ø²)</th><th>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶Ø¹Ù</th></tr>
                </thead>
                <tbody>`;
        globalSubjects.forEach((sub) => {
          const scores = subjectScores[sub] || [];
          const max = scores.length ? Math.max(...scores) : 0;
          const min = scores.length ? Math.min(...scores) : 0;
          const total = subjectTotals[sub] || 1;
          const exc = globalCounts[sub]["Ù…Ù…ØªØ§Ø²"] || 0;
          const weak = globalCounts[sub]["Ø¶Ø¹ÙŠÙ"] || 0;
          const strengthRate = ((exc / total) * 100).toFixed(1) + "%";
          const weaknessRate = ((weak / total) * 100).toFixed(1) + "%";
          html += `<tr><td style="font-weight:bold;">${sub}</td><td>${toArabicNumerals(max)}</td><td>${toArabicNumerals(min)}</td><td style="color:var(--success-color); font-weight:bold; direction:ltr;">${toArabicNumerals(strengthRate)}</td><td style="color:var(--danger-color); font-weight:bold; direction:ltr;">${toArabicNumerals(weaknessRate)}</td></tr>`;
        });
        html += `</tbody></table></div>`;
        container.innerHTML = html;
      }

      function renderChart() {
        const ctx = document.getElementById("gradesChart").getContext("2d");
        if (window.myChart) window.myChart.destroy();
        Chart.defaults.font.family = "'Cairo', sans-serif";
        Chart.defaults.font.size = 13;

        const datasets = gradesOrder
          .slice()
          .reverse()
          .map((g) => ({
            label: g,
            data: globalSubjects.map((s) => globalCounts[s][g]),
            backgroundColor: gradeColors[g],
            borderRadius: 4,
            barPercentage: 0.7,
          }));

        window.myChart = new Chart(ctx, {
          type: "bar",
          data: { labels: globalSubjects, datasets: datasets },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                grid: { display: false },
                ticks: { font: { size: 13, weight: "bold" } },
              },
              y: {
                beginAtZero: true,
                position: "right",
                ticks: {
                  font: { size: 13 },
                  // Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯: ÙŠØ­ÙˆÙ„ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø­ÙˆØ± Ø§Ù„ØµØ§Ø¯ÙŠ Ù„Ù„Ø¹Ø±Ø¨ÙŠØ©
                  callback: function (value) {
                    return toArabicNumerals(value);
                  },
                },
              },
            },
            plugins: {
              legend: {
                position: "top",
                labels: { font: { size: 13, weight: "bold" } },
              },
              title: {
                display: true,
                text: "Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„ÙŠ Ù„Ù„Ù…ÙˆØ§Ø¯",
                font: { size: 16, family: "Cairo", weight: "bold" },
                padding: { bottom: 10 },
              },
              // Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯: ÙŠØ­ÙˆÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¹Ù†Ø¯ ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù…Ø§ÙˆØ³ Ù„Ù„Ø¹Ø±Ø¨ÙŠØ©
              tooltip: {
                callbacks: {
                  label: function (context) {
                    return (
                      context.dataset.label +
                      ": " +
                      toArabicNumerals(context.raw)
                    );
                  },
                },
              },
            },
          },
        });
      }

      function exportToExcel() {
        if (globalSubjects.length === 0) {
          alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª!");
          return;
        }
        const data = [];
        globalSubjects.forEach((sub) => {
          const total = subjectTotals[sub] || 1;
          const row = { Ø§Ù„Ù…Ø§Ø¯Ø©: sub, "Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„ÙŠ": total };
          gradesOrder.forEach((g) => {
            row[`Ø¹Ø¯Ø¯ ${g}`] = globalCounts[sub][g];
          });
          gradesOrder.forEach((g) => {
            row[`Ù†Ø³Ø¨Ø© ${g}`] =
              ((globalCounts[sub][g] / total) * 100).toFixed(1) + "%";
          });
          const scores = subjectScores[sub] || [];
          row["Ø§Ù„Ù…ØªÙˆØ³Ø·"] = calcMean(scores);
          row["Ø§Ù„ÙˆØ³ÙŠØ·"] = calcMedian(scores);
          row["Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù"] = calcStdDev(scores);
          data.push(row);
        });
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„Ù†ØªØ§Ø¦Ø¬");
        XLSX.writeFile(wb, "Analysis_Report_V26.xlsx");
      }

      function calcMean(scores) {
        if (!scores || scores.length === 0) return "0";
        return (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1);
      }
      function calcMedian(scores) {
        if (!scores || scores.length === 0) return "0";
        const s = [...scores].sort((a, b) => a - b);
        const m = Math.floor(s.length / 2);
        return s.length % 2 !== 0 ? s[m] : ((s[m - 1] + s[m]) / 2).toFixed(1);
      }
      function calcStdDev(scores) {
        if (!scores || scores.length === 0) return "0";
        const m = scores.reduce((a, b) => a + b, 0) / scores.length;
        return Math.sqrt(
          scores.map((v) => Math.pow(v - m, 2)).reduce((a, b) => a + b, 0) /
            scores.length,
        ).toFixed(2);
      }
      function toArabicNumerals(str) {
        return (str + "").replace(/[0-9]/g, (d) => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©"[d]);
      }
    </script>
    <footer class="app-footer no-print" dir="rtl">
      <div>
        ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ù„Ø¨Ø±Ù…Ø¬Ø© ÙˆØ§Ù„ØªØ·ÙˆÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø©:
        <a href="https://gemini.google.com/" target="_blank">Gemini 2.0</a>
        <span style="margin: 0 8px; color: #cbd5e1">|</span>
        <a href="https://t.me/Interact2030" target="_blank"
          >Ø­Ù‚ÙˆÙ‚ Ø§Ù„ØªØ·ÙˆÙŠØ± Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù„Ù…Ù„ØªÙ‚Ù‰ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ</a
        >
      </div>
    </footer>
  </body>
</html>
